<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <script src="scripts/jquery-2.0.3.js"></script>
    <script src="scripts/jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.js"></script>
    <script src="scripts/jquery.blockUI.js"></script>
    <link href="Styles/MyCustomStyles.css" rel="stylesheet" />

    <link href="scripts/jquery.jqGrid-4.5.2/css/ui.jqgrid.css" rel="stylesheet" />
    <script src="scripts/jquery.jqGrid-4.5.2/js/jquery.jqGrid.src.js"></script>
    <script type="text/javascript" src="scripts/jquery.jqGrid-4.5.2/js/i18n/grid.locale-en.js"></script>
    <script src="scripts/jquery.blockUI.js"></script>

    <script src="scripts/MyCustomScripts2.js"></script>
    <script src="scripts/common_objects.js"></script>
    <script src="scripts/designer_functions.js"></script>
    <script src="scripts/research_functions.js"></script>

    <script src="scripts/raphael-min.js"></script>

    <title>Warzone 2100 Guide • Research</title>

<script>

var player = 0;

$(function () {

    InitDataObjects();

    LoadAllObjects(function () {
        DoResearchAll(player_all_researched, true, function () {
            DrawResearchTimeline();
        });
    })
    DrawSection_type2_1_html("intro_header", "Introduction").append($('#intro_content'));
    DrawSection_type2_1_html("time_table_header", "Research Timeline").append($('#time_table_container'));
    


});


function DrawResearchTimeline() {
    
    DrawScaleSlider('scale_slider', 100, function (value) {
        var scale = value / 100;
        DrawCompTimeTable("time_table_canva", scale);
    });
    DrawCompTimeTable("time_table_canva", 1);
}

var scale_setted_timeout;
function DrawScaleSlider(container_id, init_value, slide_function) {

    $('#' + container_id).html('');
    var slider_id = container_id + "_scale_slider";
    var input_id = container_id + "_scale_slider_input";
    var slider_elem = $('<label for="' + input_id + '">Scale:</label><input type="text" id="' + input_id + '" style="border: 0; font-weight: bold;" /><div id="' + slider_id + '"></div>');
    slider_elem.appendTo($("#" + container_id));
    jQuery('#' + slider_id).slider({
        min: 10,
        max: 300,
        step: 1,
        value: init_value,
        range: "min",
        slide: function (event, ui) {
            jQuery('#' + input_id).val(ui.value + "%");
            if (scale_setted_timeout != undefined) {
                clearTimeout(scale_setted_timeout);
                scale_setted_timeout = undefined;
            };
            scale_setted_timeout = setTimeout(function () {

                if (slide_function != undefined) {
                    slide_function($('#' + slider_id).slider("value"));
                }
            }, 300);
        }
    });
    $('#' + input_id).val($('#' + slider_id).slider("value") + "%");
}

; (function (Raphael) {
    /// Plugin - replaces original RaphaelJS .image constructor
    /// with one that respects original dimensions.
    /// Optional overrides for each dimension.

    var originalRaphaelImageFn = Raphael.fn.image;
    /**
	 * Overload - replace Raphael .image function with one that respects original dimensions
	 * @param  {string} url the image path
	 * @param  {number} x   position-x
	 * @param  {number} y   position-y
	 * @param  {number} w   dimensions-width
	 * @param  {number} h   dimensions-height
	 * @return {Paper.Element}     new raphael element
	 */
    Raphael.fn.image = function (url, x, y, w, h) {
        // fix the image dimensions to match original scale unless otherwise provided
        if (!w || !h) {
            var img = new Image();
            img.src = url;
            if (!w) w = img.width;
            if (!h) h = img.height;
        }
        return originalRaphaelImageFn.call(this, url, x, y, w, h);
    };
})(Raphael);

function DrawCompTimeTable(container_id, scale) {
    //1px = 1 sec
    if (scale == undefined) {
        scale = 1;
    }
    var sec_per_pixel = scale;
    var h = 2000;
    $('#' + container_id).html('');
    $('#' + container_id).append('<div id="timeTableSvgCanva"></div>');
    var max_res_time = 0;

    /* Distance between two vertical lines*/
    var vertical_lines_period_thin = 60; //pixels
    var vertical_lines_period_thick = 600; //pixels
    if (scale > 0.5 && scale < 0.9) {
        vertical_lines_period_thick = 300;
    } else if (scale <= 0.5) {
        vertical_lines_period_thick = 180;
    }

    /* Calculate maximum research time */
    for (var i in Researches.loaded_data) {
        var res_time = ResearchTime[player_all_researched][Researches.loaded_data[i].grid_id]
        if (res_time != undefined) {
            max_res_time = Math.max(res_time, max_res_time);
        }
    }

    /* Draw paper */
    var x_size = max_res_time * sec_per_pixel + 200;
    var y_size = 1151;
    var paper = new Raphael('timeTableSvgCanva', x_size, y_size);

    /* Draw time grid lines */
    var x_offset = 100;
    var y_offset = 50;
    var text_offset_y = 30 - 10;
    paper.text(x_offset - 50, text_offset_y, "Timeline");
    paper.path("M30 30L" + x_size + " 30");

    var bottom_timeline_y = y_size - 50;
    var y_lines_max = y_size - 45;
    paper.text(x_offset - 50, bottom_timeline_y + 7, "Timeline");
    paper.path("M30 " + bottom_timeline_y + "L" + x_size + " " + bottom_timeline_y);
    for (var i = 0; i <= x_size; i = i + vertical_lines_period_thin) {
        var x = i + x_offset;
        var time = Math.floor(i / sec_per_pixel); //time in seconds
        var y0 = y_offset - 25;
        if (i % vertical_lines_period_thick == 0) {
            paper.path("M" + x + " " + y0 + "L" + x + " " + y_lines_max).attr("stroke-width", "2");
            paper.text(x, text_offset_y, time.tohhMMSS()).attr("font-weight", "bold");
            paper.text(x, bottom_timeline_y + 7, time.tohhMMSS()).attr("font-weight", "bold");
        } else {
            paper.path("M" + x + " " + y0 + "L" + x + " " + y_lines_max).attr("opacity", 0.7);
            paper.text(x, text_offset_y, time.tohhMMSS());
            paper.text(x, bottom_timeline_y + 7, time.tohhMMSS());
        }
    }

    var can_research = function (comp_id) {
        return ResearchedComponents[player_all_researched][comp_id] != undefined;
    }

    /* Prepare array of Research Lines */
    var res_lines = [];
    {
        /* Body line */
        var line = {};
        line.DataObject = Bodies;
        line.items_ids = {};
        for (var body_id in Bodies.loaded_data_hash) {
            if (can_research(body_id)) {
                line.items_ids[body_id] = 1;
            }
        }
        res_lines.push(line);
    }
    {
        /* propulsion line */
        var line = {};
        line.color = "darkblue";
        line.DataObject = Propulsion;
        line.items_ids = {};
        for (var prop_id in Propulsion.loaded_data_hash) {
            if (can_research(prop_id)) {
                line.items_ids[prop_id] = 1;
            }
        }
        res_lines.push(line);
    }

    {
        /* Base structures line */
        var line = {};
        line.color = "darkpink";
        line.DataObject = Structures;
        line.items_ids = {};
        for (var si in Structures.loaded_data) {
            var struc = Structures.loaded_data[si];
            if (can_research(struc.grid_id)) {
                if (struc.type == "FACTORY MODULE" || struc.type == "POWER MODULE" || struc.type == "RESEARCH MODULE"
                    || struc.type == "REPAIR FACILITY" || struc.type == "SAT UPLINK" || struc.type == "CYBORG FACTORY"
                    || struc.type == "VTOL FACTORY" || struc.type == "REARM PAD") {
                    line.items_ids[struc.grid_id] = 1;
                }
            }
        }
        res_lines.push(line);
    }

    {
        /* Weapon lines */
        var weap_res_classes = {};
        for (var i in Weapons.loaded_data) {
            var weapon = Weapons.loaded_data[i];
            if (!can_research(weapon.grid_id)) {
                continue;
            }
            var res_class = weapon.weaponSubClass;
            if (res_class == undefined) {
                continue;
            }
            if (weap_res_classes[res_class] == undefined) {
                weap_res_classes[res_class] = {};
                weap_res_classes[res_class].minResearchTime = weapon.minResearchTime;
                weap_res_classes[res_class].weapons_ids = {};;
                weap_res_classes[res_class].weapons_ids[weapon.grid_id] = 1;
            } else {
                weap_res_classes[res_class].weapons_ids[weapon.grid_id] = 1;
                weap_res_classes[res_class].minResearchTime = Math.min(weapon.minResearchTime, weap_res_classes[res_class].minResearchTime);
            }
        }
        var weap_res_classes_array = [];
        for (var res_class in weap_res_classes) {
            weap_res_classes_array.push({
                res_class: res_class,
                minResearchTime: weap_res_classes[res_class].minResearchTime,
                weapons_ids: weap_res_classes[res_class].weapons_ids,
            });
        }

        weap_res_classes_array.sort(function (elm1, elm2) {
            return elm1.minResearchTime - elm2.minResearchTime;
        });

        for (var i in weap_res_classes_array) {
            var line = {};
            line.color = "darkred";
            line.DataObject = Weapons;
            line.items_ids = weap_res_classes_array[i].weapons_ids;
            res_lines.push(line);
        }
    }

    var pushed_structs = {};
    {
        /* defenses line - bunkers */
        var line = {};
        line.DataObject = Structures;
        line.items_ids = {};
        for (var struc_id in Structures.loaded_data_hash) {
            var struc = Structures.loaded_data_hash[struc_id];
            if (can_research(struc_id)) {
                if (struc.strength == "BUNKER") {
                    if (struc.type == "DEFENSE" || struc.type == "GENERIC") {
                        line.items_ids[struc_id] = 1;
                        pushed_structs[struc_id] = 1;
                    }
                }
            }
        }
        res_lines.push(line);
    }

    {
        /* defenses line - hardpoints */
        var line = {};
        line.DataObject = Structures;
        line.items_ids = {};
        for (var struc_id in Structures.loaded_data_hash) {
            var struc = Structures.loaded_data_hash[struc_id];
            if (can_research(struc_id)) {
                if (pushed_structs[struc_id]== undefined && struc.name.indexOf("ardpoint") > 0) {
                    if (struc.type == "DEFENSE" || struc.type == "GENERIC") {
                        line.items_ids[struc_id] = 1;
                        pushed_structs[struc_id] = 1;
                    }
                }
            }
        }
        res_lines.push(line);
    }

    {
        /* defenses line - sensors */
        var line = {};
        line.DataObject = Structures;
        line.items_ids = {};
        line.color = "blue";
        for (var struc_id in Structures.loaded_data_hash) {
            var struc = Structures.loaded_data_hash[struc_id];
            if (can_research(struc_id)) {
                if (pushed_structs[struc_id] == undefined && struc.sensorID != undefined && struc.weapons == undefined) {
                    line.items_ids[struc_id] = 1;
                    pushed_structs[struc_id] = 1;
                }
            }
        }
        res_lines.push(line);
    }

    {
        /* defenses line - other */
        var line = {};
        line.DataObject = Structures;
        line.items_ids = {};
        for (var struc_id in Structures.loaded_data_hash) {
            var struc = Structures.loaded_data_hash[struc_id];
            if (can_research(struc_id)) {
                if (pushed_structs[struc_id] == undefined) {
                    if (struc.type == "DEFENSE" || struc.type == "GENERIC") {
                        line.items_ids[struc_id] = 1;
                        pushed_structs[struc_id] = 1;
                    }
                }
            }
        }
        res_lines.push(line);
    }

    for (var line_num in res_lines) {
        res_lines[line_num].min_time = 100 * 100;
        res_lines[line_num].max_time = 0;
        res_lines[line_num].pos_y = line_num * 50 + y_offset;
    }


    /* Draw researches which are included in Research Lines */
    for (var res_id in Researches.loaded_data_hash) {
        var research = Researches.loaded_data_hash[res_id];
        var result_comps = [];
        /* prepare array of research results */
        if (research.resultComponents != undefined) {
            result_comps = result_comps.concat(research.resultComponents.split(','));
        }
        if (research.resultStructures != undefined) {
            result_comps = result_comps.concat(research.resultStructures.split(','));
        }
        if (result_comps.length == 0) {
            continue;
        }
        /* iterate research results */
        for (var ir in result_comps) {
            var comp_id = result_comps[ir];
            if (!can_research(comp_id)) {
                continue;
            }
            for (var line_num in res_lines) {
                var line = res_lines[line_num];
                if (line.items_ids[comp_id] != undefined) { //found component in research line
                    var DataObject = line.DataObject;
                    var comp = DataObject.loaded_data_hash[comp_id];
                    var res_time = ResearchTime[player_all_researched][res_id];
                    var elm_icon;
                    var icon_x = res_time * sec_per_pixel + x_offset;
                    if (GetIcon_CheckIconFilenameHashed(GetIcon_filename(comp_id)))
                    {
                        elm_icon = paper.image(GetIcon_src(DataObject.icon_folder, comp_id), icon_x, line.pos_y, 48, 48).attr("alt", comp.name);
                    }else
                    {
                        elm_icon = paper.rect(icon_x, line.pos_y, 48, 48).attr("title", comp.name).attr("fill", "gray");
                        paper.text(icon_x, line.pos_y + 10, comp.name);
                    }
                    elm_icon.attr("title", comp.name + "\nResearch time: " + res_time.tohhMMSS())
                    elm_icon.orig_form = elm_icon.transform(); // remember current transform
                    elm_icon.comp = comp;
                    elm_icon.DataObject = DataObject;
                    elm_icon.hover(
                        function () {
                            //this.toFront(); - this line makes animation buggy in IE 10. 
                            this.animate({ transform: "...s1.3,1.3" }, 300, 'bounce');
                        },
                        function () {
                            this.animate({ transform: this.orig_form.toString() }, 500, 'bounce');
                            this.toFront(); //set to front after animation to avoid bug in IE 10
                        }
                        );
                    elm_icon.click(function () {
                        if (this.DataObject.page_url != undefined) {
                            window.open(this.DataObject.page_url + "?details_id=" + this.comp.grid_id);
                        }
                    });
                    elm_icon.attr("cursor", "pointer");
                    line.min_time = Math.min(line.min_time, res_time);
                    line.max_time = Math.max(line.max_time, res_time);
                    break;
                }
            }
        }
    }

    /* Draw hotizontal connection lines */
    for (var line_num in res_lines) {
        var line = res_lines[line_num];
        var y = line.pos_y + 24;
        var x1 = line.min_time * sec_per_pixel + x_offset;
        var x2 = line.max_time * sec_per_pixel + x_offset;
        var color = line.color == undefined ? "darkGreen" : line.color; 
        paper.path("M" + x1 + " " + y + "L" + x2 + " " + y).attr("stroke", color).attr("stroke-width", "2.2").toBack();
    }

}

</script>
</head>
<body>
    <table class="ui-widget ui-corner-all">
        <tr>
            <td id="page_header">

            </td>
        </tr>
        <tr>
            <td id="page_caption" data-caption="Research Guide">

            </td>
        </tr>
    <tr>
        <td style="width:100%;vertical-align:top">
           <div id="intro_header">
           </div>
           <div id="intro_content">
               <p>
                   Research is most complicated thing in Warzone.
                   <br />Below you can see Research Timeline.                   
               </p>
               <span style="color:red">Note: this page is not finished yet</span>
            </div>
            <div id="time_table_header">
            </div>
            <div id="time_table_container" >
                <div id="scale_slider" style="width:500px"></div>
                <div id="time_table_canva" style="background-color:white"></div>
            </div>
           
        </td>
    </tr>
    </table>




        <label style="float:right; margin-right:100px; color:gray">made by crab_ ©</label>
</body>
</html>
