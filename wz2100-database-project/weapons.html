<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <script src="scripts/jquery-2.0.3.js"></script>
    <script src="scripts/jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.js"></script>
    <script src="scripts/jquery.blockUI.js"></script>
    <link href="scripts/jquery-ui-1.10.3.custom/css/custom-theme/jquery-ui-1.10.3.custom.css" rel="stylesheet" />
    <link href="Styles/MyCustomStyles.css" rel="stylesheet" />

    <link href="scripts/jquery.jqGrid-4.5.2/css/ui.jqgrid.css" rel="stylesheet" />
    <script src="scripts/jquery.jqGrid-4.5.2/js/jquery.jqGrid.src.js"></script>
    <script type="text/javascript" src="scripts/jquery.jqGrid-4.5.2/js/i18n/grid.locale-en.js"></script>
    <script src="scripts/jquery.blockUI.js"></script>

    <script src="scripts/MyCustomScripts2.js"></script>
    <script src="scripts/common_objects.js"></script>
    <script src="scripts/designer_functions.js"></script>
    <script src="scripts/research_functions.js"></script>

    <script src="scripts/properties_desription.js"></script>

    <title></title>

    <script>

var player = 0;

var res_time;
$(function () {

    InitDataObjects();
    $("#tabs_left").tabs();
    $("#tabs_left").tabs("option", "active", 0);

    $('#tabs_left ul:first li:eq(0) a').click(null, function (event) {
                
    });

    $('#tabs_left ul:first li:eq(1) a').click(null, function (event) {
        DrawDetailsTab_Init();
    });


    $('#tabs_left ul:first li:eq(2) a').click(null, function (event) {
        OpenDamageModifiers();

    });

    if (localStorage["weapons_research_state_seconds"] == undefined) {
        localStorage["weapons_research_state_seconds"] = 600;
    }

    //var res_time = localStorage["weapons_research_state_seconds"];
    //if (res_time == undefined) {
    //    return;
    //}
    res_time = 600;

    ShowLoading('tabs_left');
    LoadAllObjects(function () {
        DoResearchAll(player_all_researched,true, function () {
            DrawResearchSlider("research_slider",
                res_time,
                function (value) {
                        DoResearch(value, player, function () {
                            DrawWeaponList();
                    });
                });
            DoResearch(res_time, player, function () {
                DrawWeaponList();
            });
            HideLoading('tabs_left');
        });
    });



    //attach click events to each tab
    //for (var i = 0; i < Objects.length; i++) {
    //    $('#tabs_left ul:first li:eq(' + Objects[i].tab_index + ') a').click(Objects[i], function (event) {
    //        var DataObject = event.data;
    //        DataObject.LoadLeftGridFunction();
    //    });
    //}

    //SelectedObject.LoadLeftGridFunction();
});

function OpenDamageModifiers() {
    $("#tabs_left").tabs("option", "active", 2);
    var html = "";
    html += '<div class="ui-widget-header ui-corner-top" style="padding: 5px;">Propulsion Damage Modifiers</div><div id="propulsion_modifiers" class="ui-widget-content ui-corner-bottom"></div>';

    html += '<div class="ui-widget-header ui-corner-top"  style="padding: 5px; margin-top:10px">Structure Damage Modifiers</div><div id="structure_modifiers"></div>';
    $("#left-tabs-2").html(html);

    LoadDataObject(StructureModifiers, function () {
        LoadDataObject(PropulsionModifiers, function () {
            DrawGrid(PropulsionModifiers, "propulsion_modifiers", null, 600);
            DrawGrid(StructureModifiers, "structure_modifiers", null, 600);
        });
    });
}

function IsAviableWeapon(weapon) {
    if (weapon.designable == undefined) {/* Check Weapon designable */
        return false;
    }
    if (ResearchedComponents[player_all_researched][weapon.grid_id] == undefined)/* Check Weapon can be researched */ {
        return false;
    }
    return true;
}

var weap_modifiers_str;

function DrawWeaponList() {

   // DoResearch(res_time, player, function () {
    FillPropModifierHash();
        $("#tank_weapons").html('');
        $("#cyborg_weapons").html('');
        $("#vtol_weapons").html('');
        $("#other_weapons").html('');
        var tank_weapons = DrawSection_type2_html("tank_weapons", "Tank Weapons");  
        var cyborg_weapons = DrawSection_type2_html("cyborg_weapons", "Cyborg Weapons");
        var vtol_weapons = DrawSection_type2_html("vtol_weapons", "VTOL Weapons");
        var other_weapons = DrawSection_type2_html("other_weapons", "Other Weapons");

        /* Researchable weapons */
        var collected_weapons = {};
        /* Tank weapons */
        {
            var func_tank_weapons = function (weapon) {
                if (!IsAviableWeapon(weapon)) return false;
                var abils = Weapon_GetAbilities(weapon);
                if (abils.VTOLWeapon || abils.CyborgWeapon) {/* Check Weapon not VTOL, not Cyborg */
                    return false;
                }
                collected_weapons[weapon.grid_id] = 1;
                return true;
            };
            var elem = DrawSection_type1_html(tank_weapons.attr('id'), "");
            elem.append("<label>Tank weapons splitted into sections by 'research line'. Each section contains list of weapons which use same upgrades, \
                e.g. when you research machinegun damage you have increased damage of all weapons in MACHINE GUN section.\
                <br/>Click on weapon to see detailed view.</label>");
            DrawWeaponLines(tank_weapons.attr('id'), func_tank_weapons);
        }

        /* Cyborgs Weapons */
        {
            var func_cyborgs_weapons = function (weapon) {
                if (ResearchedComponents[player_all_researched][weapon.grid_id] == undefined)/* Check Weapon can be researched */ {
                    return false;
                }
                var abils = Weapon_GetAbilities(weapon);
                if (!abils.CyborgWeapon) {/* Check Weapon is cyborg weapon */
                    return false;
                }
                collected_weapons[weapon.grid_id] = 1;
                return true;
            };
            var elem = DrawSection_type1_html(cyborg_weapons.attr('id'), "");
            DrawWeapons(elem.attr('id'), null, func_cyborgs_weapons);
        }

        /* VTOL Weapons */
        {
            var func_vtol_weapons_bombs = function (weapon) {
                if (!IsAviableWeapon(weapon)) return false;
                if (!Weapon_GetAbilities(weapon).VTOLWeapon) {/* Check Weapon is VTOL-Weapon */
                    return false;
                }
                if (weapon.weaponEffect != "ARTILLERY ROUND") {
                    return false;
                }
                collected_weapons[weapon.grid_id] = 1;
                return true;
            };
            var func_vtol_weapons_aa = function (weapon) {
                if (!IsAviableWeapon) return false;
                var abils = Weapon_GetAbilities(weapon);
                if (!abils.VTOLWeapon || !(abils.CanHitVtols && abils.CannotHitGround)) {/* Check Weapon is VTOL-Weapon */
                    return false;
                }
                collected_weapons[weapon.grid_id] = 1;
                return true;
            };
            var func_vtol_weapons = function (weapon) {
                if (!IsAviableWeapon(weapon)) return false;
                if (!Weapon_GetAbilities(weapon).VTOLWeapon) {/* Check Weapon is VTOL-Weapon */
                    return false;
                }
                if (collected_weapons[weapon.grid_id] != undefined) {
                    return false;//this case to skip VTOL-bombs
                }
                collected_weapons[weapon.grid_id] = 1;
                return true;
            };
            var elem1 = DrawSection_type1_html(vtol_weapons.attr('id'), "Bombs");
            DrawWeapons(elem1.attr('id'), null, func_vtol_weapons_bombs, VTOL_cols);
            var elem2 = DrawSection_type1_html(vtol_weapons.attr('id'), "Interceptors (Air-to-Air weapons)");
            DrawWeapons(elem2.attr('id'), null, func_vtol_weapons_aa, VTOL_cols);
            var elem3 = DrawSection_type1_html(vtol_weapons.attr('id'), "Other VTOL Weapons");
            DrawWeapons(elem3.attr('id'), null, func_vtol_weapons, VTOL_cols);
        }

        /* Other weapons */
        {
            var building_weapons = {};
            {
                /* Collect weapons used for buildings */
                for (var i = 0; i < Structures.loaded_data.length; i++) {
                    if (Structures.loaded_data[i].weapons != undefined) {
                        if (ResearchedComponents[player_all_researched][Structures.loaded_data[i].grid_id] == undefined) {
                            //skip structures which cannot be researched
                            continue;
                        }
                        var struc_weaps = Structures.loaded_data[i].weapons.split(',');
                        for (var e = 0 ; e < struc_weaps.length; e++) {
                            building_weapons[struc_weaps[e]] = 1;
                        }
                    }
                }
            }
            var func_other_weapons = function (weapon) {
                if (collected_weapons[weapon.grid_id] != undefined) { // skip weapons which was listed already
                    return false;
                }

                if (building_weapons[weapon.grid_id] == undefined && ResearchedComponents[player_all_researched][weapon.grid_id] == undefined) {
                    return false; //skip non-researchable weapons which also not used on buildings
                }

                collected_weapons[weapon.grid_id] = 1;
                return true;
            };
            var elem = DrawSection_type1_html(other_weapons.attr('id'), "");
            DrawWeapons(elem.attr('id'), null, func_other_weapons);
        }
    //});
}


function FillPropModifierHash()
{
    weap_modifiers_str = {};
    for(var mdf in PropulsionModifiers.loaded_data_hash)
    {
        var m = PropulsionModifiers.loaded_data_hash[mdf];
        var str = "";
        for (var prop_type in PropulsionType.loaded_data_hash)
        {
            var val = m[prop_type] == undefined ? ' - ' : m[prop_type];
            str = str + prop_type + ":" + val + "%, ";
        }
        weap_modifiers_str[mdf] = str;
    }
}

function DrawWeaponLines(container_id, weapon_filer_function) {

    var WeapLines = {};
    var WeapLines_array = [];
    for(var weap_id in Weapons.loaded_data_hash)
    {
        var res_comp_item = ResearchedComponents[player_all_researched][weap_id];
        var weapon = Weapons.loaded_data_hash[weap_id];
        if (!weapon_filer_function(weapon)) {
            continue;
        }
        if(res_comp_item == undefined)
        {
            continue;
        }

        var weapSubClass = weapon.weaponSubClass;
        if(weapSubClass == undefined)
        {
            continue;
        }

        weap_line = WeapLines[weapSubClass];
        if(weap_line == undefined)
        {
            weap_line = {};
            weap_line.weaponSubClass = weapSubClass;
            weap_line.min_research_time = res_comp_item.time_seconds;
            weap_line.weapons = {};
            weap_line.weapons = [weap_id];
            WeapLines[weapSubClass] = weap_line;  
            WeapLines_array.push(weap_line);
        }else
        {
            weap_line.min_research_time = Math.min(weap_line.min_research_time, res_comp_item.time_seconds);
            weap_line.weapons.push(weap_id);
        }
    }

    WeapLines_array.sort(function (elm1, elm2) {
        return elm1.min_research_time - elm2.min_research_time;
    });
    for(var i=0; i < WeapLines_array.length; i++)
    {
        var elem = DrawSection_type1_html($('#' + container_id).attr('id'), WeapLines_array[i].weaponSubClass);
        DrawWeapons(elem.attr('id'), WeapLines_array[i].weapons,null );
    }
}

var VTOL_cols = [
    {
        label: "VTOL Ammo", name: "ammo", width: 45, formatter: function (cellvalue, options, rowObject) {
            return CalcVTOL_numshots(rowObject);
        }, sorttype: "int"
    },

    ]

var listed_weapons = {};
function DrawWeapons(container_id, weap_id_list, weapon_filter_function, additional_columns) {
    /* prepare list of structures depending on function parameters */
    if (additional_columns == null || additional_columns == undefined) {
        additional_columns = [];
    }
    var grid_data = [];
    if (weap_id_list == null) {
        for (var weap_id in Weapons.loaded_data_hash) {
            if (weapon_filter_function(Weapons.loaded_data_hash[weap_id])) {
                var weapon = Weapons.loaded_data_hash[weap_id];
                var weapon_upgraded = jQuery.parseJSON(JSON.stringify(Upgrades[player].Weapon[weapon.index_of_datarow]))
                weapon_upgraded.base = weapon;
                //var weap_c = {};
                //weap_c.base = {};
                //CalculateWeaponStats_AddToObjects(player, weap, weap_c, weap_c.base, weap_c, false);
                //grid_data.push(weap_c);
                grid_data.push(weapon_upgraded);
            }
        }
    } else {
        for (var i = 0; i < weap_id_list.length; i++) {
            var weapon = Weapons.loaded_data_hash[weap_id_list[i]];
            var weapon_upgraded = jQuery.parseJSON(JSON.stringify(Upgrades[player].Weapon[weapon.index_of_datarow]))
            weapon_upgraded.base = weapon;
            grid_data.push(weapon_upgraded);
        }
    }

    /* calculate parameters of weapons */
    for (var i = 0; i < grid_data.length; i++) {

        /* save listed weapons */
        listed_weapons[grid_data[i].grid_id] = 1;
    }

    grid_data.sort(function (a, b) {
        return a.minResearchTime - b.minResearchTime;
    });


    var table_id = container_id + '_table';
    var html = '<table id="' + table_id + '" ></table>';
    $('#' + container_id).append('<div style="margin-top:5px">' + html + '</div>');
    var grid = $('#' + table_id);

    grid.jqGrid
    ({
        datatype: "local",
        data: grid_data,
        rowNum: grid_data.length,
        height: 'auto',
        colModel:
        [
            { label: "", name: "grid_id", key: true, hidden: true },
            {
                label: " ",
                name: 'pic',
                width: '65px',
                sortable: false,
                search: false,
                formatter: function (cellvalue, options, rowObject) {
                    return '<a href="javascript:openWeaponDetails(\'' + rowObject.grid_id + '\')">' + Weapons.GetIconHtml_Function(rowObject) + '</a>';
                },
            },
            {
                label: " ", name: "name",
                formatter: function (cellvalue, options, rowObject) {
                    return '<a href="javascript:openWeaponDetails(\'' + rowObject.grid_id + '\')">' + cellvalue + '</a>';
                },
            },
            {
                label: "Range", name: "longRange", sorttype: "int", formatter: function (cellvalue, options, rowObject) {
                    return (cellvalue / 128).toFixed(1)
                }, width: 40
            },
            {
                label: "Damage", sortable: false,
                formatter: function (cellvalue, options, rowObject) {
                    return WeaponDamage_htmlCell(rowObject);
                },
                width: 130
            },
            {
                label: "Rate of Fire", sortable: false,
                formatter: function (cellvalue, options, rowObject) { return Weapon_ShotsPerMinute(rowObject).toFixed(1) + " /min"; }, width: 70,//
            },
            {
                label: "HP", sortable: false,
                formatter: function (cellvalue, options, rowObject) {
                    return rowObject.hitpoints;
                },
                width: 70,
            },
            {
                label: "Price", name: "buildPower", width: 45, formatter: function (cellvalue, options, rowObject) {
                    return '<label style="color:#116611">$' + cellvalue + '</label>';
                }, sorttype: "int"
            },
            {
                label: "<label title='Minimum time of research'>Research</label>",
                name: "minResearchTime",
                width: 80,
                formatter: function (cellvalue, options, rowObject) {
                    var res_comp_item = ResearchedComponents[player_all_researched][rowObject.grid_id];
                    if (res_comp_item != undefined) {
                        var value = res_comp_item.time_seconds;
                        if (value < 3600) {
                            return value.toMMSS();
                        } else {
                            return value.toHHMMSS();
                        }
                    }
                    return ' - ';
                },
            },
            {
                label: "<label title='Propulsion damage modifiers (Class)'>Class</label>",
                width: 70,
                name: "weaponEffect",
                formatter: function (cellvalue, options, rowObject) {
                    return '<a href="javascript:OpenDamageModifiers()" style="font-size:0.8em;" title="' + weap_modifiers_str[cellvalue] + '" >' + cellvalue + '</a>';//<span class="ui-icon ui-icon-extlink" style="display:inline-block"></span>
                },
            },
        ].concat(additional_columns).concat([
                        {
                            label: "Abilities",
                            width: 300,
                            formatter: function (cellvalue, options, rowObject) {
                                var abils = Weapon_GetAbilities(rowObject);
                                var res_html = "<ul style='margin:2px; font-size:0.9em'>";
                                for (var ability in abils) {
                                    if (abils[ability]) {
                                        var des = Abilities_Description(ability);
                                        if (!des.designer_only_ability) {
                                            res_html += '<li><i>' + des.name + '</i></li>';
                                        }
                                    }
                                }
                                return '</ul>' + res_html;
                            },
                        },
                        ]),
        onSelectRow: function (rowid) {
        },
        loadonce: true,
        ignoreCase: true, //make search case insensitive
    });


}


function show_nonres() {
    if ($('#nonres_weaps').length == 0) {
        sect = $('<div id="nonres_weaps"></div>');
        sect.insertAfter("#other_weapons");
        var weap_sect = DrawSection_type2_html(sect.attr('id'), "Unavailable weapons");
        var sect2 = DrawSection_type1_html(weap_sect.attr('id'), "");
        DoResearch(res_time, player, function () {
            {
                var func = function (weapon) {
                    return listed_weapons[weapon.grid_id] == undefined;
                };
                DrawWeapons(sect2.attr('id'), null, func);
            }
        });
    }
    document.getElementById("nonres_weaps").scrollIntoView();
}

function showAA() {
    if ($('#aa_weaps').length == 0) {
        sect = $('<div id="aa_weaps"></div>');
        sect.insertAfter("#other_weapons");
        var aa_weap = DrawSection_type2_html(sect.attr('id'), "Anti-Air Weapons");
        var sect2 = DrawSection_type1_html(aa_weap.attr('id'), "");
        sect2.append("<label>Weapons which can attack only flying <i>VTOL units</i>. This weapons cannot hit ground objects.</label>");
        DoResearch(res_time, player, function () {
            {
                var func = function (weapon) {
                    if (!IsAviableWeapon(weapon)) return false;
                    var abils = Weapon_GetAbilities(weapon);
                    if (!(abils.CanHitVtols && abils.CannotHitGround)) {
                        return false;
                    }
                    return true;
                };
                DrawWeapons(sect2.attr('id'), null, func);
            }
        });
    }
    document.getElementById("aa_weaps").scrollIntoView();
}

function showArty() {
    if ($('#arty_weaps').length == 0) {
        sect = $('<div id="arty_weaps"></div>');
        sect.insertAfter("#other_weapons");
        var weap_sect = DrawSection_type2_html(sect.attr('id'), "Artillery");
        var sect2 = DrawSection_type1_html(weap_sect.attr('id'), "");
        DoResearch(res_time, player, function () {
            {
                var func = function (weapon) {
                    if (!IsAviableWeapon(weapon)) return false;
                    var abils = Weapon_GetAbilities(weapon);
                    if (!abils.Indirect || abils.CannotHitGround) {
                        return false;
                    }
                    return true;
                };
                DrawWeapons(sect2.attr('id'), null, func);
            }
        });
    }
    document.getElementById("arty_weaps").scrollIntoView();
}

function showAPWeaps() {
    if ($('#AP_weaps').length == 0) {
        sect = $('<div id="AP_weaps"></div>');
        sect.insertAfter("#other_weapons");
        var weap_sect = DrawSection_type2_html(sect.attr('id'), "Anti-cyborg Weapons");
        var sect2 = DrawSection_type1_html(weap_sect.attr('id'), "");
        DoResearch(res_time, player, function () {
            {
                var func = function (weapon) {
                    if (!IsAviableWeapon(weapon)) return false;
                    var abils = Weapon_GetAbilities(weapon);
                    if (abils.CannotHitGround || weapon.weaponEffect != "ANTI PERSONNEL") {
                        return false;
                    }
                    return true;
                };
                DrawWeapons(sect2.attr('id'), null, func);
            }
        });
    }
    document.getElementById("AP_weaps").scrollIntoView();
}

function showAntiDef() {
    if ($('#AntiDef_weaps').length == 0) {
        sect = $('<div id="AntiDef_weaps"></div>');
        sect.insertAfter("#other_weapons");
        var weap_sect = DrawSection_type2_html(sect.attr('id'), "Anti-defense weapons");
        var sect2 = DrawSection_type1_html(weap_sect.attr('id'), "");
        DoResearch(res_time, player, function () {
            {
                var func = function (weapon) {
                    if (!IsAviableWeapon(weapon)) return false;
                    var abils = Weapon_GetAbilities(weapon);
                    if (abils.CannotHitGround || weapon.weaponEffect != "BUNKER BUSTER") {
                        return false;
                    }
                    return true;
                };
                DrawWeapons(sect2.attr('id'), null, func);
            }
        });
    }
    document.getElementById("AntiDef_weaps").scrollIntoView();
}

function showOverpowred() {
    if ($('#OP_weaps').length == 0) {
        sect = $('<div id="OP_weaps"></div>');
        sect.insertAfter("#other_weapons");
        var weap_sect = DrawSection_type2_html(sect.attr('id'), "Weapons which are overpowered in Multiplayer");
        DoResearch(res_time, player, function () {
            {
                var low_sect = DrawSection_type1_html(weap_sect.attr('id'), "Overpowered weapons at low-oil games");
                var op_list1 = ["MG4ROTARYMk1", "Bomb4-VTOL-HvyINC", "Flame1Mk1", "Flame2"];
                DrawWeapons(low_sect.attr('id'), op_list1);

                var hi_sect = DrawSection_type1_html(weap_sect.attr('id'), "Overpowered weapons at high-oil games");
                var op_list2 = ["Bomb4-VTOL-HvyINC", "Bomb5-VTOL-Plasmite", "Howitzer150Mk1", "Mortar-Incenediary"];
                DrawWeapons(hi_sect.attr('id'), op_list2);
            }
        });
    }
    document.getElementById("OP_weaps").scrollIntoView();
}

function openWeaponDetails(weapon_id) {
    $("#tabs_left").tabs("option", "active", 1);
    DrawDetailsTab_Init(weapon_id);
}


function DrawDetailsTab_Init(weapon_id) {
    var res_time = 600;

    DrawResearchSlider("research_slider_details",
        res_time,
        //localStorage["weapons_research_state_seconds"],
        function (value) {
            //if (value != localStorage["weapons_research_state_seconds"]) {
            //    localStorage["weapons_research_state_seconds"] = value;
            //}

            DoResearch(value, 0, function () {
                DrawWeaponDetailsParameters(weapon_id);
            });
        });

    if (weapon_id != undefined) {
        DoResearch(res_time, 0, function () {
            DrawWeaponDetailsParameters(weapon_id);
            DrawWeaponStaticData(weapon_id);
        });
    }
}

function DrawWeaponDetailsParameters(weap_id) {
    var weapon = Weapons.loaded_data_hash[weap_id];
    var weapon_upgraded = GetTurretUpgrade(player, weap_id, false)[weapon.index_of_datarow];

    $("#select_weapon_button").button({
        icons: {
            primary: "ui-icon-triangle-1-s",
        }
    }).click(function (event) {
        event.preventDefault();
        ShowSeletDialog_forDataObject(Weapons, weap_id, function (weap_id_new) {
            DrawWeaponDetailsParameters(weap_id_new);
            DrawWeaponStaticData(weap_id_new);
        });
    });

    $("#weapon_icon").html(Weapons.GetIconHtml_Function(weapon));
    $("#weapon_name_label").text(weapon.name);
    $("#abilities_container").html(Form_Weapon_Abilities_html(weapon));
    

    $('#weapon_details_details').html('<div id="weapon_details_details_container"></div>');
    var grid_data = CalcWeaponRelatedParameters(weapon, weapon_upgraded);
    DrawComponentDetailsGrid(grid_data, "weapon_details_details_container");

    Designer_Draw_DPSTable("dps_table_container", [weapon_upgraded], player);
}

function DrawWeaponStaticData(weapon_id) {

    var weapon = Weapons.loaded_data_hash[weapon_id];

    /* Draw Damage modifiers table */
    var grid_data_mdf = [];
    var modif = PropulsionModifiers.loaded_data_hash[weapon.weaponEffect];
    for (var prop_type in PropulsionType.loaded_data_hash) {
        grid_data_mdf.push({
            propulsion: prop_type,
            modifier: modif[prop_type] == undefined ? ' - ' : modif[prop_type] + '%',
        });
    }
    var grid_element_id = ResetGridContainer("weapon_details_damage_modifiers");
    var grid = $(grid_element_id);
    grid.jqGrid
    ({
        datatype: "local",
        data: grid_data_mdf,
        rowNum: grid_data_mdf.length,
        height: '100%',
        colModel:
            [
                { name: "propulsion", width: '100px', fixed: true },
                { name: "modifier", width: '50px', fixed: true },
            ],
        loadonce: true,
    });

    /* Draw Research Path */
    var res_path_data = GetResearchPath_SubTree(weapon_id, player_all_researched, 5);
    DrawResearchPath_Tree("research_path_container", res_path_data);

    /* Draw damage upgrades table */
    DrawUpgradeTable("damage_upgrades_container", weapon_id, "damage");
    DrawUpgradeTable("rof_upgrades_container", weapon_id, "firepause");
}

function DrawUpgradeTable(container_id, weapon_id, research_hint) {
    var weapon = Weapons.loaded_data_hash[weapon_id];
    var weapon_upgraded = GetTurretUpgrade(player_all_researched, weapon_id, false)[weapon.index_of_datarow];
    var upgrade_log = weapon_upgraded.upgrade_history;
    var grid_data = [];
    var summ = 100;
    for (var i in upgrade_log) {
        var log_rec = upgrade_log[i];
        var research = Researches.loaded_data_hash[log_rec.research_id];
        if (log_rec.hint.toLowerCase() == research_hint) {
            summ = summ + log_rec.value;
            grid_data.push({
                name: research.name,
                time_int: ResearchTime[player_all_researched][log_rec.research_id],
                value: log_rec.value,
                summ: summ,
            });
        }
    }

    var grid_element_id = ResetGridContainer(container_id);
    var grid = $(grid_element_id);
    grid.jqGrid
    ({
        datatype: "local",
        data: grid_data,
        rowNum: grid_data.length,
        height: '100%',
        colModel:
            [
                { name: "name", label: "Research", width: '200px', fixed: true },
                { name: "time_int", width: '50px', fixed: true, hidden: true, sorttype: "int", },
                {
                    label: "Research Time (min)",
                    width: 80,
                    formatter: function (cellvalue, options, rowObject) {
                        if (rowObject.time_int == undefined) {
                            return '<label style="color:gray;font-size:0.9em;">cant research(!)</label>';
                        }
                        if (rowObject.time_int < 3600) {
                            return rowObject.time_int.toMMSS();
                        } else {
                            return rowObject.time_int.toHHMMSS();
                        }
                    },
                },
                //{ name: "value", label: "Upgrade value", width: '100px', fixed: true, formatter: function (cellvalue, options, rowObject) { return cellvalue + '%' } },
                { name: "summ", label: "Summ Upgrade value", width: '100px', fixed: true, formatter: function (cellvalue, options, rowObject) { return cellvalue + '%' } },
            ],
        sortname: "time_int",
        loadonce: true,
    });
}

    </script>
</head>
<body style="background:#eeeeee;">
    <table style="width:95%;max-width:1200px;min-width:800px ;margin-left: auto ; margin-right: auto ;">
        <tr>
            <td id="page_header">

            </td>
        </tr>
        <tr>
            <td id="page_caption" data-caption="Weapons Guide">

            </td>
        </tr>
    <tr>
        <td style="width:100%;vertical-align:top">
            <div id="tabs_left" >
                <ul>
                    <li><a href="#left-tabs-1">Weapon Guide</a></li>
                    <li><a href="#left-tabs-detail">Weapon detail</a></li>
                    <li><a href="#left-tabs-2">Damage Modifiers</a></li>
                </ul>
                <div id="left-tabs-1">
                    <div class="ui-accordion ui-widget ui-helper-reset" role="tablist" >
	                    <h3 style="text-align:left" class="ui-accordion-header ui-helper-reset ui-state-default ui-accordion-icons ui-accordion-header-active ui-state-active ui-corner-top">
                            <span class="ui-accordion-header-icon ui-icon ui-icon-triangle-1-s" style="float:left;"></span>
                           Introduction
	                    </h3>
                        <div id="Div2" class="ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active" style="display: block; text-align:left">
                            Weapon is most important part of Tank Design. Strong Weapon can be useful even on weak body and slow propulsion.<br />
                            <b>First of all:</b> Weapon damage is greatly dependent on enemy propulsion type. See <a href="javascript:OpenDamageModifiers()">Weapon damage modifiers</a> for exact values.<br />
                            Each weapon have one of two kinds of damage type: <label style="color:blue">kinetic</label> and <label style="color:red">thermal</label>.
                        </div>
                    </div>
                    <table>
                        <tr>
                            <td>
                                <ul  class="MyStyledLinkMenu" style="display:inline-block">
                                    <li><a href="#tank_weapons">Tank Weapons</a></li>
                                    <li><a href="#cyborg_weapons">Cyborg Weapons</a></li>
                                    <li><a href="#vtol_weapons">VTOL Weapons</a></li>
                                    <li><a href="#other_weapons">Other Weapons</a></li>
                                    <li><a href="javascript:show_nonres()">Unavailable Weapons</a></li>
                                </ul>
                            </td>
                            <td>
                                <ul class="MyStyledLinkMenu" style="display:inline-block">
                                    <li><a href="javascript:showAA()">Anti-Air (AA) Weapons</a></li>
                                    <li><a href="javascript:showArty()">Artillery</a></li>
                                    <li><a href="javascript:showAPWeaps()">Anti-Cyborg Weapons</a></li>
                                    <li><a href="javascript:showAntiDef()">Anti-defense weapons</a></li>
                                    <li><a href="javascript:showOverpowred()">Overpowered Weapons</a></li>
                                </ul>
                            </td>
                            <td style="width:40%">
                                <div  class="ui-widget ui-corner-all" style="padding: -2px; width:500px; display:inline-block; float:right">
                                    <div id="research_slider">

                                    </div>
                                    <label style="font-size:0.9em; color:gray;float:right">Use slider to see numeric values for different states of research.</label>
                                </div>
                            </td>
                        </tr>
                    </table>


                    <div id="tank_weapons"></div>
                    <div id="cyborg_weapons"></div>
                    <div id="vtol_weapons"></div>
                    <div id="other_weapons"></div>
                </div>
                <div id="left-tabs-2">

                </div>
                <div id="left-tabs-detail">
                    <table style="width:100%">
                        <tr>
                            <td colspan="2">
                                <div id="selected_weapon_header">
                                    <span id="weapon_icon"></span>
                                    <label id="weapon_name_label" style="font-size:1.2em">[...]</label>
                                </div>
                            </td>
                            <td>
                                You can see details for any weapon, just select another weapon. <br />
                                <div style="width:100%;text-align:center">
                                    <button id="select_weapon_button" type="button" style="display:inline-block">Select Weapon...</button>
                                </div>
                                
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <div class="ui-accordion ui-widget ui-helper-reset" role="tablist" style="margin-top:20px">
	                                <h3 style="text-align:left" class="ui-accordion-header ui-helper-reset ui-state-default ui-accordion-icons ui-accordion-header-active ui-state-active ui-corner-top">
                                        <span class="ui-accordion-header-icon ui-icon ui-icon-triangle-1-s" style="float:left;"></span>
                                        Description
	                                </h3>
                                    <div id="Div4" class="ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom ui-accordion-content-active" style="display: block; text-align:left">
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div  class="ui-widget ui-corner-all" style="padding: -2px; width:500px; display:inline-block;">
                                    <div id="research_slider_details">

                                    </div>
                                    <label style="font-size:0.9em; color:gray;">Use slider to see numeric values for different states of research.</label>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td style="vertical-align:top; width:45%">
                                <div class="ui-widget-content ui-corner-bottom" style="padding:2px" id="main_parameters_container"></div>

                                <div class="ui-widget-header ui-corner-top" style="padding:2px">Detail Parameters</div>
                                <div class="ui-widget-content ui-corner-bottom" style="padding:2px" id="weapon_details_details"></div>
                                <div class="ui-widget-header ui-corner-top" style="padding:2px">Damage modifiers</div>
                                <div class="ui-widget-content ui-corner-bottom" style="padding:2px" id="weapon_details_damage_modifiers"></div>
                                <div class="ui-widget-header ui-corner-top" style="padding:2px">DPS stats (Damage per second)</div>
                                <div class="ui-widget-content ui-corner-bottom" style="padding:2px" id="dps_table_container"></div>
                            </td>
                            <td style="vertical-align:top; width:35%">
                                <div class="ui-widget-header ui-corner-top" style="padding:2px;">Abilities</div>
                                <div class="ui-widget-content ui-corner-bottom" style="padding:2px" id="abilities_container"></div>
                                <div class="ui-widget-header ui-corner-top" style="padding:2px">Research</div>
                                <div class="ui-widget-content ui-corner-bottom" style="padding:2px" id="research_path_container"></div>

                            </td>
                            <td style="vertical-align:top; width:20%">
                                <div class="ui-widget-header ui-corner-top" style="padding:2px">Damage Upgrades</div>
                                <div class="ui-widget-content ui-corner-bottom" style="padding:2px" id="damage_upgrades_container"></div>

                                <div class="ui-widget-header ui-corner-top" style="padding:2px">Rate of Fire Upgrades</div>
                                <div class="ui-widget-content ui-corner-bottom" style="padding:2px" id="rof_upgrades_container"></div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </td>
    </tr>
    </table>

    <div id="modifiers_container" style="display:none">

    </div>

        <label style="float:right; margin-right:100px; color:gray">made by crab_ ©</label>
</body>
</html>
